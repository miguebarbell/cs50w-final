import datetimefrom django.contrib.auth import authenticate, login, logoutfrom django.shortcuts import HttpResponse, render, redirectfrom django.urls import reversefrom .models import User, Passwordfrom django.db import IntegrityErrorfrom django.contrib.auth.decorators import login_requiredfrom django.http import HttpResponseRedirect, JsonResponsefrom .passwgen import generatefrom .forms import PassFormimport datetime# Create your views here.def index(request):    # Authenticated users view their inbox    if request.user.is_authenticated:        return render(request, "index.html", {'user': request.user})    # Everyone else is prompted to sign in    else:        return HttpResponseRedirect(reverse("login"))def login_view(request):    if request.method == "POST":        # Attempt to sign user in        username = request.POST["username"]        password = request.POST["password"]        user = authenticate(request, username=username, password=password)        # Check if authentication successful        if user is not None:            login(request, user)            return HttpResponseRedirect(reverse("index"))        else:            return render(request, "login.html", {                "message": "Invalid username and/or password."            })    else:        return render(request, "login.html")def logout_view(request):    logout(request)    return HttpResponseRedirect(reverse("index"))def register(request):    if request.method == "POST":        username = request.POST["username"]        # Ensure password matches confirmation        password = request.POST["password"]        confirmation = request.POST["confirmation"]        if password != confirmation:            return render(request, "register.html", {                "message": "Passwords must match."            })        # Attempt to create new user        try:            user = User.objects.create_user(username, password)            user.save()        except IntegrityError as e:            print(e)            return render(request, "register.html", {                "message": "Username already taken."            })        login(request, user)        return HttpResponseRedirect(reverse("index"))    else:        return render(request, "register.html")# @csrf_exempt@login_requireddef home(request):    """    This is the main page with all the passwords stored.    return json    """    items = Password.objects.all()    user = User.objects.get(username=request.user)    response = {}    length = 0    for item in items:        if user == item.user:            length += 1            response[item.id] = {'title': item.title, 'username': item.username, 'password': item.password,                                 'note': item.notes, 'date': item.date}    return JsonResponse({'response': response, 'status': 201, 'length': length})@login_requireddef edit(request, id):    """    edit a password given this id    """    pass_obj = Password.objects.get(id=id)    # print(int(pass_obj.id))    # print(type(int(pass_obj.id)))    pform = PassForm(initial={'title': pass_obj.title,                              'username': pass_obj.username,                              'password': pass_obj.password,                              'notes': pass_obj.notes})    if request.method == 'POST' and request.user == pass_obj.user:        # print(request.POST.get('title'))        pass_obj.title = request.POST.get('title')        pass_obj.username = request.POST.get('username')        pass_obj.password = request.POST.get('password')        pass_obj.notes = request.POST.get('notes')        pass_obj.save()        return redirect('index')    return render(request, 'edit.html', {'id': pass_obj, 'form': pform, 'idint': int(pass_obj.id)})def gen(request, len=8, esp=False):    """    generate a password    """    form = PassForm(initial={'password': generate(len=10, esp='True')})    if request.method == 'POST':        new = Password(user=request.user,                       title=request.POST.get('title'),                       username=request.POST.get('username'),                       password=request.POST.get('password'),                       notes=request.POST.get('notes'),                       date=datetime.datetime.now)        new.save()        return redirect('index')    return render(request, 'generate.html', {'form': form})@login_required()def delete(request, id):    item = Password.objects.get(id=id)    # if request.user == Password.objects.get(id=id):    if request.user == item.user:        Password.objects.filter(id=id).delete()    return redirect('index')def genapi(request, len=8, esp=False):    print(generate(len, esp))    return JsonResponse({'pass': generate(len, esp)})def profile(request):    # TODO: export to file    # TODO: delete account    numbers_of_passwords = Password.objects.filter(user=request.user)    print(len(numbers_of_passwords))    return render(request, 'profile.html', {'user': request.user,                                            'numberofpasswords': len(numbers_of_passwords)                                            })def delete_profile(request):    User.objects.get(username=request.user).delete()    return redirect('register')def export_db(request):    db = Password.objects.filter(user=request.user)    f = open(f'{request.user}.txt', 'w+')    inner_id = 1    for entry in db:        f.write(f'Number: {inner_id} \n'                f'Title: {entry.title} \n'                f"Date: {entry.date.strftime('%X %x')} \n"                f'Username: {entry.username} \n'                f'Password: {entry.password} \n'                f'Notes: {entry.notes} \n\n')        inner_id += 1    f.write('\n')    f.write(f"generated: {datetime.datetime.now().strftime('%X %a %x')}")    f.close()    f = open(f'{request.user}.txt', 'r')    response = HttpResponse(f, content_type='application/text')    response['Content-Disposition'] = f'attachment; filename={request.user}.txt'    return response